name: Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: ${{ matrix.os }} / ${{ matrix.qt-binding }} / numpy-${{ matrix.numpy-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        qt-binding: [pyside6, pyqt6, pyqt5]
        numpy-version: ['1.24.4', '1.26.4', '2.1.0']

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libopengl0 libxkbcommon-x11-0 libdbus-1-3 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 x11-utils xvfb
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        
      - name: Set up Python
        run: uv python install 3.10
        
      - name: Create Virtual Environment
        run: uv venv

      - name: Install Base Dependencies
        run: uv pip install .

      - name: Install Matrix Dependencies
        shell: bash
        run: |
          uv pip install "numpy==${{ matrix.numpy-version }}"
          
          if [[ "${{ matrix.qt-binding }}" == "pyside6" ]]; then
            uv pip install "pyside6==6.8.1"
          elif [[ "${{ matrix.qt-binding }}" == "pyqt6" ]]; then
            uv pip install "pyqt6==6.8.1"
          elif [[ "${{ matrix.qt-binding }}" == "pyqt5" ]]; then
            uv pip install pyqt5
          fi
          
          uv pip install pytest pytest-qt pandas
          
          echo "Installed Qt Binding Version:"
          uv pip show ${{ matrix.qt-binding }}
          

        
      - name: Run Tests
        # Set QT_API environment variable based on binding
        env:
          QT_API: ${{ matrix.qt-binding }}
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            xvfb-run -a uv run --no-sync pytest
          else
            uv run --no-sync pytest
          fi
